<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OSINT Search Tool</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0; padding: 20px;
      background: #f9f9f9;
      color: #222;
    }
    .container { max-width: 900px; margin: 0 auto; }
    h1, h2, h3 { color: #B13F17; margin-bottom: 10px; }
    input, select, button {
      padding: 8px 10px; margin: 5px 0; font-size: 1rem;
      border: 1px solid #ccc; border-radius: 4px;
    }
    input[type="url"], input[type="text"], select { width: 100%; max-width: 350px; }
    button { cursor: pointer; border: none; background-color: #B13F17; color: white; transition: background-color 0.3s ease; border-radius: 4px; min-width: 110px; }
    button:hover { background-color: #8a2e11; }
    button:disabled { background-color: #ccc; cursor: not-allowed; }
    .btn-brand { min-width: 120px; }
    .btn-small { min-width: 80px; padding: 5px 8px; font-size: 0.9rem; }
    section { margin-bottom: 30px; background: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.05); }
    .category { border-bottom: 1px solid #eee; padding: 8px 0; }
    .category:last-child { border-bottom: none; }
    .category-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 8px; cursor: pointer; font-weight: 600; user-select: none; transition: all 0.3s ease; background: linear-gradient(135deg, #f8f8f8 0%, #f0f0f0 100%); border: 1px solid #e0e0e0; border-radius: 6px; margin-bottom: 4px; }
    .category-header:hover { background: linear-gradient(135deg, #f0e6e1 0%, #e8ddd8 100%); border-color: #B13F17; }
    .category-title { font-weight: 600; }
    .category-websites { padding-left: 20px; display: none; flex-direction: column; gap: 6px; margin-top: 8px; }
    .category-websites.visible { display: flex; }
    .website-item { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; }
    .website-item label { display: flex; align-items: center; flex-grow: 1; cursor: pointer; }
    .website-item input[type="checkbox"] { margin-right: 8px; width: auto; }
    .website-item a { color: #B13F17; text-decoration: none; flex-grow: 1; }
    .website-item a:hover { text-decoration: underline; }
    .edit-btn, .delete-btn { background: transparent; border: none; color: #B13F17; cursor: pointer; font-size: 0.9rem; margin-left: 8px; min-width: auto; padding: 4px 6px; }
    .edit-btn:hover, .delete-btn:hover { color: #8a2e11; background: #f0f0f0; }
    .manage-categories, .manage-websites { margin-top: 15px; }
    .manage-categories input, .manage-websites input, .manage-websites select { width: calc(100% - 130px); display: inline-block; }
    .manage-websites input, .manage-websites select { margin-right: 10px; max-width: 300px; }
    .website-manage-list { margin-top: 20px; padding: 15px; background: #f8f8f8; border-radius: 6px; }
    .website-manage-list h4 { margin-top: 0; color: #666; }
    .toggle-icon { transition: transform 0.2s; }
    .toggle-icon.rotated { transform: rotate(180deg); }
    @media (max-width: 600px) { .container { padding: 10px; } .manage-categories input, .manage-websites input, .manage-websites select { width: 100%; margin-bottom: 8px; } }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>OSINT Search Tool</h1>
    </header>
    <section class="search-section">
      <input type="text" id="keywordInput" placeholder="Enter keyword(s)">
      <button id="searchBtn" class="btn-brand">Search</button>
    </section>
    <section class="advanced-filters">
      <h2>Advanced Filters</h2>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 10px;">
        <div>
          <h3 style="color: #1877f2; margin: 0 0 8px 0; font-size: 1rem;">🔗 LinkedIn Filters</h3>
          <label>Location: <input type="text" id="linkedinLocation" placeholder="e.g., London, UK"></label>
          <label>Job Title: <input type="text" id="linkedinJobTitle" placeholder="e.g., Investigator"></label>
          <label>Company: <input type="text" id="linkedinCompany" placeholder="e.g., Microsoft"></label>
          <label>School: <input type="text" id="linkedinSchool" placeholder="e.g., Harvard University"></label>
        </div>
        <div>
          <h3 style="color: #1877f2; margin: 0 0 8px 0; font-size: 1rem;">📘 Facebook Filters</h3>
          <label>Location: <input type="text" id="facebookLocation" placeholder="e.g., London, UK"></label>
          <label>Education: <input type="text" id="facebookEducation" placeholder="e.g., Harvard University"></label>
          <label>Workplace: <input type="text" id="facebookWorkplace" placeholder="e.g., Microsoft"></label>
          <label>Relationship: <select id="facebookRelationship">
            <option value="">Any</option>
            <option value="single">Single</option>
            <option value="relationship">In a relationship</option>
            <option value="married">Married</option>
          </select></label>
        </div>
      </div>
      <div style="background: #f0f8ff; padding: 8px; border-radius: 4px; font-size: 0.85em; color: #0066cc;">
        💡 <strong>Note:</strong> Filters are automatically applied to LinkedIn and Facebook searches when those categories are selected.
      </div>
    </section>
    <section class="categories-section">
      <h2>Search Categories</h2>
      <div style="margin-bottom: 15px;">
        <button id="selectAllBtn" class="btn-small">Select All</button>
        <button id="deselectAllBtn" class="btn-small">Deselect All</button>
      </div>
      <div id="categoriesContainer"></div>
    </section>
    <section class="manage-section">
      <h2>Manage Categories & Websites</h2>
      <div class="manage-categories">
        <h3>Categories</h3>
        <div id="manageCategoriesContainer"></div>
        <input type="text" id="newCategoryInput" placeholder="New category name">
        <button id="addCategoryBtn" class="btn-brand">Add Category</button>
      </div>
      <div class="manage-websites">
        <h3>Add Website</h3>
        <select id="categorySelectForWebsites"></select>
        <input type="text" id="newWebsiteName" placeholder="Website name">
        <input type="url" id="newWebsiteURL" placeholder="Website URL (include https://)">
        <button id="addWebsiteBtn" class="btn-brand">Add Website</button>
      </div>
    </section>
    <section class="results-section">
      <h2>Search Results</h2>
      <div id="resultsContainer">
        <p style="color: #666;">Enter keywords and select websites to search.</p>
      </div>
      <button id="exportReportBtn" class="btn-brand">Export Report</button>
    </section>
    <section class="saved-cases-section">
      <h2>Saved Cases</h2>
      <input type="text" id="searchSavedCases" placeholder="Search saved cases...">
      <div id="savedCasesContainer"></div>
      <button id="clearSavedCasesBtn" class="btn-brand" style="background:#555;">Clear All Saved Cases</button>
    </section>
  </div>
  <script>
    // Preloaded categories and websites
    let categories = {
      "Company Searches": [
        { name: "Companies House (UK)", url: "https://find-and-update.company-information.service.gov.uk/search/companies" },
        { name: "SEC EDGAR (US)", url: "https://www.sec.gov/edgar/searchedgar/companysearch.html" }
      ],
      "Court Case Searches": [
        { name: "CaseMine", url: "https://www.casemine.com/search" },
        { name: "Justia", url: "https://dockets.justia.com/" }
      ],
      "Professional Registers": [
        { name: "GDC UK", url: "https://www.gdc-uk.org/pages/searchregisters.aspx" },
        { name: "NMC", url: "https://www.nmc.org.uk/registration/search-the-register/" },
        { name: "GMC", url: "https://www.gmc-uk.org/registration-and-licensing/the-medical-register" },
        { name: "SRA (Solicitors)", url: "https://www.sra.org.uk/consumers/register/" },
        { name: "ICO", url: "https://ico.org.uk/about-the-ico/contact-us/register-of-data-controllers/" }
      ],
      "Social Media": [
        { name: "LinkedIn", url: "https://www.linkedin.com/search/results/people/" },
        { name: "Facebook", url: "https://www.facebook.com/search/people/" },
        { name: "Twitter/X", url: "https://twitter.com/search" }
      ],
      "People Search": [
        { name: "Pipl", url: "https://pipl.com/" },
        { name: "WhitePages", url: "https://www.whitepages.com/" },
        { name: "TruePeopleSearch", url: "https://www.truepeoplesearch.com/" }
      ]
    };

    // DOM elements
    const categoriesContainer = document.getElementById("categoriesContainer");
    const manageCategoriesContainer = document.getElementById("manageCategoriesContainer");
    const categorySelectForWebsites = document.getElementById("categorySelectForWebsites");
    const newCategoryInput = document.getElementById("newCategoryInput");
    const addCategoryBtn = document.getElementById("addCategoryBtn");
    const newWebsiteName = document.getElementById("newWebsiteName");
    const newWebsiteURL = document.getElementById("newWebsiteURL");
    const addWebsiteBtn = document.getElementById("addWebsiteBtn");
    const searchBtn = document.getElementById("searchBtn");
    const keywordInput = document.getElementById("keywordInput");
    const resultsContainer = document.getElementById("resultsContainer");
    const exportReportBtn = document.getElementById("exportReportBtn");
    const savedCasesContainer = document.getElementById("savedCasesContainer");
    const searchSavedCasesInput = document.getElementById("searchSavedCases");
    const clearSavedCasesBtn = document.getElementById("clearSavedCasesBtn");
    const linkedinLocationInput = document.getElementById("linkedinLocation");
    const linkedinJobTitleInput = document.getElementById("linkedinJobTitle");
    const linkedinCompanyInput = document.getElementById("linkedinCompany");
    const linkedinSchoolInput = document.getElementById("linkedinSchool");
    const facebookLocationInput = document.getElementById("facebookLocation");
    const facebookEducationInput = document.getElementById("facebookEducation");
    const facebookWorkplaceInput = document.getElementById("facebookWorkplace");
    const facebookRelationshipInput = document.getElementById("facebookRelationship");
    const selectAllBtn = document.getElementById("selectAllBtn");
    const deselectAllBtn = document.getElementById("deselectAllBtn");

    // Store saved cases
    const SAVED_CASES_KEY = "osint_saved_cases";
    let uploadedImageData = null;

    // --- Utility Functions ---

    function showMessage(message, type = 'info') {
      const existingMessage = document.querySelector('.message');
      if (existingMessage) existingMessage.remove();
      
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      messageDiv.textContent = message;
      messageDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 6px;
        color: white;
        font-weight: 500;
        z-index: 1000;
        max-width: 300px;
        ${type === 'error' ? 'background: #dc3545;' : 
          type === 'success' ? 'background: #28a745;' : 
          'background: #17a2b8;'}
      `;
      
      document.body.appendChild(messageDiv);
      setTimeout(() => messageDiv.remove(), 3000);
    }

    function validateURL(urlString) {
      try {
        const url = new URL(urlString);
        return url.protocol === 'http:' || url.protocol === 'https:';
      } catch {
        return false;
      }
    }

    function buildSearchURL(site, keyword, filters = {}) {
      let searchURL = site.url;
      const encodedKeyword = encodeURIComponent(keyword);
      
      // Enhanced URL building for specific sites
      if (site.name.toLowerCase().includes('linkedin')) {
        if (searchURL.includes('/search/results/people/')) {
          searchURL += `?keywords=${encodedKeyword}`;
          if (filters.linkedinLocation) {
            searchURL += `&geoUrn=${encodeURIComponent(filters.linkedinLocation)}`;
          }
          if (filters.linkedinJobTitle) {
            searchURL += `&title=${encodeURIComponent(filters.linkedinJobTitle)}`;
          }
          if (filters.linkedinCompany) {
            searchURL += `&currentCompany=${encodeURIComponent(filters.linkedinCompany)}`;
          }
          if (filters.linkedinSchool) {
            searchURL += `&school=${encodeURIComponent(filters.linkedinSchool)}`;
          }
        }
      } else if (site.name.toLowerCase().includes('facebook')) {
        // Facebook Graph Search approach
        let fbSearchURL = 'https://www.facebook.com/search/people/?q=' + encodedKeyword;
        let filters_applied = [];
        
        if (filters.facebookLocation) {
          filters_applied.push(`location:${encodeURIComponent(filters.facebookLocation)}`);
        }
        if (filters.facebookEducation) {
          filters_applied.push(`education:${encodeURIComponent(filters.facebookEducation)}`);
        }
        if (filters.facebookWorkplace) {
          filters_applied.push(`employer:${encodeURIComponent(filters.facebookWorkplace)}`);
        }
        if (filters.facebookRelationship) {
          filters_applied.push(`relationship:${encodeURIComponent(filters.facebookRelationship)}`);
        }
        
        if (filters_applied.length > 0) {
          fbSearchURL += '%20' + filters_applied.join('%20');
        }
        
        searchURL = fbSearchURL;
      } else if (site.name.toLowerCase().includes('twitter') || site.name.toLowerCase().includes('/x')) {
        searchURL += `?q=${encodedKeyword}`;
      } else if (site.name.toLowerCase().includes('companies house')) {
        searchURL += `?q=${encodedKeyword}`;
      } else {
        // Generic approach - try to append search parameter
        const separator = searchURL.includes('?') ? '&' : '?';
        searchURL += `${separator}q=${encodedKeyword}`;
      }
      
      return searchURL;
    }

    // --- Storage Functions ---

    function saveCasesToStorage(cases) {
      try {
        localStorage.setItem(SAVED_CASES_KEY, JSON.stringify(cases));
      } catch (error) {
        showMessage('Error saving cases to storage', 'error');
      }
    }

    function loadSavedCases() {
      try {
        const saved = localStorage.getItem(SAVED_CASES_KEY);
        return saved ? JSON.parse(saved) : [];
      } catch {
        return [];
      }
    }

    // --- Case Management Functions ---

    function renderSavedCases(filterText = "") {
      savedCasesContainer.innerHTML = "";
      const savedCases = loadSavedCases();

      const filteredCases = savedCases.filter(c =>
        c.keyword.toLowerCase().includes(filterText.toLowerCase()) ||
        c.date.toLowerCase().includes(filterText.toLowerCase())
      );

      if (filteredCases.length === 0) {
        savedCasesContainer.innerHTML = "<p style='color: #666;'>No saved cases found.</p>";
        return;
      }

      filteredCases.forEach((caseData, idx) => {
        const div = document.createElement("div");
        div.className = "saved-case-item";
        
        const caseInfo = document.createElement('div');
        caseInfo.innerHTML = `
          <strong>${caseData.keyword}</strong><br>
          <small style="color: #666;">${new Date(caseData.date).toLocaleString()}</small><br>
          <small>${caseData.selectedWebsites.length} websites selected</small>
        `;
        
        const buttonGroup = document.createElement('div');
        buttonGroup.innerHTML = `
          <button data-idx="${idx}" class="btn-small load-case-btn">Load</button>
          <button data-idx="${idx}" class="btn-small delete-case-btn" style="background:#dc3545; margin-left: 8px;">Delete</button>
        `;
        
        div.appendChild(caseInfo);
        div.appendChild(buttonGroup);
        savedCasesContainer.appendChild(div);
      });

      // Add event listeners
      document.querySelectorAll(".load-case-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const idx = parseInt(btn.dataset.idx, 10);
          loadCaseIntoSearch(filteredCases[idx]);
        });
      });
      
      document.querySelectorAll(".delete-case-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const idx = parseInt(btn.dataset.idx, 10);
          deleteSavedCase(filteredCases[idx]);
        });
      });
    }

    function loadCaseIntoSearch(savedCase) {
      keywordInput.value = savedCase.keyword;
      
      // Restore advanced filters if they exist
      if (savedCase.filters) {
              linkedinLocationInput.value = savedCase.filters.linkedinLocation || '';
      linkedinJobTitleInput.value = savedCase.filters.linkedinJobTitle || '';
      linkedinCompanyInput.value = savedCase.filters.linkedinCompany || '';
      linkedinSchoolInput.value = savedCase.filters.linkedinSchool || '';
      facebookLocationInput.value = savedCase.filters.facebookLocation || '';
      facebookEducationInput.value = savedCase.filters.facebookEducation || '';
      facebookWorkplaceInput.value = savedCase.filters.facebookWorkplace || '';
      facebookRelationshipInput.value = savedCase.filters.facebookRelationship || '';
      }
      
      // Clear all checkboxes first
      categoriesContainer.querySelectorAll("input[type=checkbox]").forEach(cb => cb.checked = false);
      
      // Restore selected categories (get unique categories from selected websites)
      const selectedCategories = [...new Set(savedCase.selectedWebsites.map(sel => sel.category))];
      selectedCategories.forEach(category => {
        const checkbox = categoriesContainer.querySelector(`input[data-category="${category}"]`);
        if (checkbox) checkbox.checked = true;
      });
      
      // Restore results if available
      if (savedCase.resultsHTML) {
        resultsContainer.innerHTML = savedCase.resultsHTML;
      }
      
      showMessage('Case loaded successfully', 'success');
    }

    function deleteSavedCase(savedCase) {
      if (!confirm('Are you sure you want to delete this saved case?')) return;
      
      let savedCases = loadSavedCases();
      savedCases = savedCases.filter(c => c.date !== savedCase.date || c.keyword !== savedCase.keyword);
      saveCasesToStorage(savedCases);
      renderSavedCases(searchSavedCasesInput.value);
      showMessage('Case deleted', 'success');
    }

    function saveCurrentCase(keyword, selectedWebsites, resultsHTML, filters = {}) {
      const savedCases = loadSavedCases();
      const newCase = {
        keyword,
        selectedWebsites,
        resultsHTML,
        filters,
        date: new Date().toISOString()
      };
      
      savedCases.push(newCase);
      
      // Keep only the last 50 cases to prevent storage bloat
      if (savedCases.length > 50) {
        savedCases.splice(0, savedCases.length - 50);
      }
      
      saveCasesToStorage(savedCases);
      renderSavedCases(searchSavedCasesInput.value);
    }

    // --- Rendering Functions ---

    function renderCategories() {
      categoriesContainer.innerHTML = "";
      
      for (const catName in categories) {
        const categoryDiv = document.createElement("div");
        categoryDiv.classList.add("category");
        categoryDiv.style.cssText = `
          display: flex;
          align-items: center;
          padding: 12px;
          margin-bottom: 8px;
          background: linear-gradient(135deg, #fff 0%, #f8f8f8 100%);
          border: 1px solid #e0e0e0;
          border-radius: 8px;
          transition: all 0.3s ease;
        `;

        // Category checkbox
        const label = document.createElement("label");
        label.style.cssText = `
          display: flex;
          align-items: center;
          cursor: pointer;
          flex-grow: 1;
        `;

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.checked = true;
        checkbox.dataset.category = catName;
        checkbox.style.cssText = `
          margin-right: 12px;
          width: 18px;
          height: 18px;
          cursor: pointer;
        `;

        const categoryInfo = document.createElement("div");
        categoryInfo.innerHTML = `
          <div style="font-weight: 600; color: #B13F17; font-size: 1.1rem; margin-bottom: 2px;">
            📋 ${catName}
          </div>
          <div style="font-size: 0.85rem; color: #666;">
            ${categories[catName].length} websites included
          </div>
        `;

        label.appendChild(checkbox);
        label.appendChild(categoryInfo);
        categoryDiv.appendChild(label);
        categoriesContainer.appendChild(categoryDiv);

        // Add hover effect
        categoryDiv.addEventListener('mouseenter', () => {
          categoryDiv.style.background = 'linear-gradient(135deg, #f8f8f8 0%, #f0f0f0 100%)';
          categoryDiv.style.borderColor = '#B13F17';
          categoryDiv.style.transform = 'translateY(-1px)';
          categoryDiv.style.boxShadow = '0 2px 8px rgba(177, 63, 23, 0.15)';
        });

        categoryDiv.addEventListener('mouseleave', () => {
          categoryDiv.style.background = 'linear-gradient(135deg, #fff 0%, #f8f8f8 100%)';
          categoryDiv.style.borderColor = '#e0e0e0';
          categoryDiv.style.transform = 'translateY(0)';
          categoryDiv.style.boxShadow = 'none';
        });
      }
    }

    function renderManageCategories() {
      manageCategoriesContainer.innerHTML = "";
      categorySelectForWebsites.innerHTML = "";

      Object.keys(categories).forEach(catName => {
        const catDiv = document.createElement("div");
        catDiv.className = "category";
        catDiv.style.display = "flex";
        catDiv.style.alignItems = "center";
        catDiv.style.justifyContent = "space-between";

        const nameSpan = document.createElement("span");
        nameSpan.textContent = catName;
        nameSpan.style.flexGrow = "1";

        const buttonGroup = document.createElement("div");

        const editBtn = document.createElement("button");
        editBtn.className = "edit-btn";
        editBtn.textContent = "Edit";
        editBtn.addEventListener("click", () => editCategory(catName));

        const deleteBtn = document.createElement("button");
        deleteBtn.className = "delete-btn";
        deleteBtn.textContent = "Delete";
        deleteBtn.addEventListener("click", () => deleteCategory(catName));

        buttonGroup.appendChild(editBtn);
        buttonGroup.appendChild(deleteBtn);

        catDiv.appendChild(nameSpan);
        catDiv.appendChild(buttonGroup);
        manageCategoriesContainer.appendChild(catDiv);

        // Add to dropdown
        const option = document.createElement("option");
        option.value = catName;
        option.textContent = catName;
        categorySelectForWebsites.appendChild(option);
      });

      // Always call renderManageWebsites to show all websites for all categories
      renderManageWebsites();
    }

    function renderManageWebsites() {
      // Remove existing website lists
      document.querySelectorAll(".website-manage-list").forEach(el => el.remove());

      let isFirstManageCategory = true;

      Object.keys(categories).forEach(catName => {
        if (categories[catName].length === 0) return;

        const container = document.createElement("div");
        container.className = "website-manage-list";

        // Create collapsible header with improved styling
        const header = document.createElement("div");
        header.className = "category-header";
        header.style.cssText = `
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 12px 8px;
          cursor: pointer;
          font-weight: 600;
          user-select: none;
          transition: all 0.3s ease;
          background: linear-gradient(135deg, #f8f8f8 0%, #f0f0f0 100%);
          border: 1px solid #e0e0e0;
          border-radius: 6px;
          margin-bottom: 8px;
          position: relative;
        `;

        const titleSpan = document.createElement("span");
        titleSpan.innerHTML = `<span style="color: #B13F17;">🛠️</span> Websites in "${catName}" <small style="color: #666; font-weight: normal;">(${categories[catName].length} sites)</small>`;
        titleSpan.style.color = "#333";

        const toggleIcon = document.createElement("span");
        toggleIcon.className = "toggle-icon";
        toggleIcon.textContent = "▼";

        header.appendChild(titleSpan);
        header.appendChild(toggleIcon);

        // Create collapsible content
        const websitesContent = document.createElement("div");
        websitesContent.className = "category-websites";
        
        // Start with first category open in manage section
        if (isFirstManageCategory) {
          websitesContent.classList.add("visible");
          toggleIcon.classList.add("rotated");
          isFirstManageCategory = false;
        } else {
          websitesContent.style.display = "none";
        }

        categories[catName].forEach((site, idx) => {
          const siteDiv = document.createElement("div");
          siteDiv.style.cssText = `
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 8px;
            background: white;
            border-radius: 4px;
          `;

          const siteInfo = document.createElement("div");
          siteInfo.style.flexGrow = "1";
          siteInfo.innerHTML = `
            <strong>${site.name}</strong><br>
            <small style="color: #666; word-break: break-all;">${site.url}</small>
          `;

          const buttonGroup = document.createElement("div");
          buttonGroup.style.marginLeft = "10px";

          const editBtn = document.createElement("button");
          editBtn.className = "edit-btn";
          editBtn.textContent = "Edit";
          editBtn.addEventListener("click", () => editWebsite(catName, idx));

          const deleteBtn = document.createElement("button");
          deleteBtn.className = "delete-btn";
          deleteBtn.textContent = "Delete";
          deleteBtn.addEventListener("click", () => deleteWebsite(catName, idx));

          buttonGroup.appendChild(editBtn);
          buttonGroup.appendChild(deleteBtn);

          siteDiv.appendChild(siteInfo);
          siteDiv.appendChild(buttonGroup);
          websitesContent.appendChild(siteDiv);
        });

        // Add click event to toggle dropdown
        header.addEventListener("click", () => {
          const isVisible = websitesContent.classList.toggle("visible");
          toggleIcon.classList.toggle("rotated", isVisible);
        });

        container.appendChild(header);
        container.appendChild(websitesContent);
        manageCategoriesContainer.appendChild(container);
      });
    }

    // --- Management Functions ---

    function editCategory(oldName) {
      const newName = prompt("Edit category name:", oldName);
      if (!newName || newName.trim() === "" || newName === oldName) return;
      
      if (categories[newName]) {
        showMessage("Category name already exists", "error");
        return;
      }
      
      categories[newName] = categories[oldName];
      delete categories[oldName];
      renderCategories();
      renderManageCategories();
      showMessage("Category updated successfully", "success");
    }

    function deleteCategory(catName) {
      if (!confirm(`Delete category "${catName}" and all its websites?`)) return;
      
      delete categories[catName];
      renderCategories();
      renderManageCategories();
      showMessage("Category deleted successfully", "success");
    }

    function editWebsite(catName, idx) {
      const site = categories[catName][idx];
      const newName = prompt("Edit website name:", site.name);
      if (!newName || newName.trim() === "") return;
      
      const newUrl = prompt("Edit website URL:", site.url);
      if (!newUrl || newUrl.trim() === "") return;
      
      if (!validateURL(newUrl)) {
        showMessage("Please enter a valid URL", "error");
        return;
      }
      
      categories[catName][idx] = { name: newName, url: newUrl };
      renderCategories();
      renderManageCategories();
      showMessage("Website updated successfully", "success");
    }

    function deleteWebsite(catName, idx) {
      const site = categories[catName][idx];
      if (!confirm(`Delete website "${site.name}" from category "${catName}"?`)) return;
      
      categories[catName].splice(idx, 1);
      renderCategories();
      renderManageCategories();
      showMessage("Website deleted successfully", "success");
    }

    // --- Search Functions ---

    function performSearch(keyword, selectedSites) {
      resultsContainer.innerHTML = '<p class="loading">🔍 Searching...</p>';
      searchBtn.disabled = true;

      const filters = {
        linkedinLocation: linkedinLocationInput.value.trim(),
        linkedinJobTitle: linkedinJobTitleInput.value.trim(),
        linkedinCompany: linkedinCompanyInput.value.trim(),
        linkedinSchool: linkedinSchoolInput.value.trim(),
        facebookLocation: facebookLocationInput.value.trim(),
        facebookEducation: facebookEducationInput.value.trim(),
        facebookWorkplace: facebookWorkplaceInput.value.trim(),
        facebookRelationship: facebookRelationshipInput.value.trim()
      };

      setTimeout(() => {
        try {
          const results = selectedSites.map(({category, index, site}) => {
            const searchURL = buildSearchURL(site, keyword, filters);
            
            // Calculate relevance score
            let score = Math.floor(Math.random() * 10) + 1; // Base random score
            
            // Boost score based on keyword matches
            const lowerKeyword = keyword.toLowerCase();
            if (site.name.toLowerCase().includes(lowerKeyword)) score += 5;
            if (site.url.toLowerCase().includes(lowerKeyword)) score += 3;
                    if (filters.linkedinLocation && site.name.toLowerCase().includes('linkedin')) score += 2;
        if (filters.linkedinJobTitle && site.name.toLowerCase().includes('linkedin')) score += 2;
        if (filters.linkedinCompany && site.name.toLowerCase().includes('linkedin')) score += 2;
        if (filters.linkedinSchool && site.name.toLowerCase().includes('linkedin')) score += 2;
        if ((filters.facebookLocation || filters.facebookEducation || filters.facebookWorkplace || filters.facebookRelationship) && site.name.toLowerCase().includes('facebook')) score += 3;

            return {
              category,
              site,
              searchURL,
              score,
              filters: filters.location || filters.jobTitle ? filters : null
            };
          });

          // Sort by score descending
          results.sort((a, b) => b.score - a.score);

          // Display results
          resultsContainer.innerHTML = "";
          
          if (results.length === 0) {
            resultsContainer.innerHTML = '<p style="color: #666;">No websites selected for search.</p>';
            return;
          }

          results.forEach(result => {
            const div = document.createElement("div");
            div.className = "result-item";
            
            let filtersText = '';
            if (result.filters && (result.filters.location || result.filters.jobTitle)) {
              const filterParts = [];
              if (result.filters.location) filterParts.push(`Location: ${result.filters.location}`);
              if (result.filters.jobTitle) filterParts.push(`Job Title: ${result.filters.jobTitle}`);
              filtersText = `<br><small style="color: #666;">Filters applied: ${filterParts.join(', ')}</small>`;
            }
            
            div.innerHTML = `
              <div style="margin-bottom: 8px;">
                <strong>${result.site.name}</strong> 
                <span style="background: #e3f2fd; padding: 2px 6px; border-radius: 3px; font-size: 0.8em; color: #1565c0;">
                  ${result.category}
                </span>
              </div>
              <div style="margin-bottom: 8px;">
                Search for: <strong>"${keyword}"</strong>${filtersText}
              </div>
              <div style="margin-bottom: 8px;">
                <em>Relevance score: ${result.score}/20</em>
              </div>
              <div>
                <a href="${result.searchURL}" target="_blank" rel="noopener noreferrer" 
                   style="color: #B13F17; text-decoration: none; font-weight: 500;">
                  🔗 Open Search →
                </a>
              </div>
            `;
            resultsContainer.appendChild(div);
          });

          // Save case automatically
          const selectedWebsitesForSave = selectedSites.map(s => ({
            category: s.category,
            index: s.index
          }));
          
          saveCurrentCase(keyword, selectedWebsitesForSave, resultsContainer.innerHTML, filters);
          showMessage(`Search completed! Found ${results.length} relevant sources.`, 'success');

        } catch (error) {
          resultsContainer.innerHTML = '<p class="error">An error occurred during search. Please try again.</p>';
          showMessage('Search failed. Please try again.', 'error');
        } finally {
          searchBtn.disabled = false;
        }
      }, 1000);
    }

    function exportReport() {
      const keyword = keywordInput.value.trim();
      if (!resultsContainer.innerHTML.trim() || resultsContainer.innerHTML.includes('Enter keywords')) {
        showMessage('No results to export', 'error');
        return;
      }

      const timestamp = new Date().toLocaleString();
      const filters = [];
      if (linkedinLocationInput.value.trim()) filters.push(`LinkedIn Location: ${linkedinLocationInput.value.trim()}`);
      if (linkedinJobTitleInput.value.trim()) filters.push(`LinkedIn Job Title: ${linkedinJobTitleInput.value.trim()}`);
      if (linkedinCompanyInput.value.trim()) filters.push(`LinkedIn Company: ${linkedinCompanyInput.value.trim()}`);
      if (linkedinSchoolInput.value.trim()) filters.push(`LinkedIn School: ${linkedinSchoolInput.value.trim()}`);
      if (facebookLocationInput.value.trim()) filters.push(`Facebook Location: ${facebookLocationInput.value.trim()}`);
      if (facebookEducationInput.value.trim()) filters.push(`Facebook Education: ${facebookEducationInput.value.trim()}`);
      if (facebookWorkplaceInput.value.trim()) filters.push(`Facebook Workplace: ${facebookWorkplaceInput.value.trim()}`);
      if (facebookRelationshipInput.value.trim()) filters.push(`Facebook Relationship: ${facebookRelationshipInput.value.trim()}`);
      
      const filtersSection = filters.length > 0 ? 
        `<div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin: 20px 0;">
          <h3 style="margin: 0 0 10px 0; color: #495057;">Applied Filters:</h3>
          <p style="margin: 0;">${filters.join(' | ')}</p>
        </div>` : '';

      const htmlContent = `
      <!DOCTYPE html>
      <html>
      <head>
        <title>OSINT Search Report - ${keyword}</title>
        <meta charset="UTF-8">
        <style>
          body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            padding: 30px; 
            max-width: 800px; 
            margin: 0 auto;
            background: #fff;
            color: #333;
          }
          h1 { 
            color: #B13F17; 
            border-bottom: 3px solid #B13F17;
            padding-bottom: 10px;
          }
          h3 { color: #555; }
          a { 
            color: #B13F17; 
            text-decoration: none; 
          }
          a:hover { text-decoration: underline; }
          .result-item { 
            margin-bottom: 25px; 
            padding: 15px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: #fafafa;
          }
          .header-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
          }
          .timestamp {
            color: #6c757d;
            font-size: 0.9em;
            margin-top: 10px;
          }
          @media print {
            body { padding: 20px; }
            a { color: #000 !important; }
          }
        </style>
      </head>
      <body>
        <div class="header-info">
          <h1>🔍 OSINT Search Report</h1>
          <h2 style="margin: 10px 0; color: #495057;">Search Query: "${keyword}"</h2>
          <div class="timestamp">Generated: ${timestamp}</div>
        </div>
        
        ${filtersSection}
        
        <h3>Search Results:</h3>
        ${resultsContainer.innerHTML}
        
        <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #dee2e6; color: #6c757d; font-size: 0.9em;">
          <p>Report generated by OSINT Search Tool</p>
          <p>⚠️ Remember to verify all information through multiple sources and follow proper OSINT methodology.</p>
        </div>
      </body>
      </html>
      `;

      try {
        const blob = new Blob([htmlContent], { type: "text/html" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `OSINT_Report_${keyword.replace(/[^a-zA-Z0-9]/g, "_")}_${new Date().toISOString().split('T')[0]}.html`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showMessage('Report exported successfully', 'success');
      } catch (error) {
        showMessage('Failed to export report', 'error');
      }
    }

    // --- Event Listeners ---

    // Search functionality
    searchBtn.addEventListener("click", () => {
      const keyword = keywordInput.value.trim();
      if (!keyword) {
        showMessage("Please enter a keyword to search", "error");
        keywordInput.focus();
        return;
      }

      const selectedSites = [];
      categoriesContainer.querySelectorAll("input[type=checkbox]:checked").forEach(cb => {
        const category = cb.dataset.category;
        if (categories[category]) {
          // Add all websites from selected categories
          categories[category].forEach((site, index) => {
            selectedSites.push({
              category,
              index,
              site: site
            });
          });
        }
      });

      if (selectedSites.length === 0) {
        showMessage("Please select at least one website to search", "error");
        return;
      }

      performSearch(keyword, selectedSites);
    });

    // Enter key support for search
    keywordInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        searchBtn.click();
      }
    });

    // Select/Deselect all functionality
    selectAllBtn.addEventListener("click", () => {
      categoriesContainer.querySelectorAll("input[type=checkbox]").forEach(cb => cb.checked = true);
      showMessage("All categories selected", "success");
    });

    deselectAllBtn.addEventListener("click", () => {
      categoriesContainer.querySelectorAll("input[type=checkbox]").forEach(cb => cb.checked = false);
      showMessage("All categories deselected", "success");
    });

    // Category management
    addCategoryBtn.addEventListener("click", () => {
      const newCat = newCategoryInput.value.trim();
      if (!newCat) {
        showMessage("Category name cannot be empty", "error");
        newCategoryInput.focus();
        return;
      }
      if (categories[newCat]) {
        showMessage("Category already exists", "error");
        return;
      }
      
      categories[newCat] = [];
      newCategoryInput.value = "";
      renderCategories();
      renderManageCategories();
      showMessage("Category added successfully", "success");
    });

    // Website management
    addWebsiteBtn.addEventListener("click", () => {
      const cat = categorySelectForWebsites.value;
      const name = newWebsiteName.value.trim();
      const url = newWebsiteURL.value.trim();
      
      if (!name || !url) {
        showMessage("Please enter website name and URL", "error");
        return;
      }
      
      if (!categories[cat]) {
        showMessage("Please select a category", "error");
        return;
      }
      
      if (!validateURL(url)) {
        showMessage("Please enter a valid URL (include https://)", "error");
        newWebsiteURL.focus();
        return;
      }

      categories[cat].push({ name, url });
      newWebsiteName.value = "";
      newWebsiteURL.value = "";
      renderCategories();
      renderManageCategories();
      showMessage("Website added successfully", "success");
    });

    // Export functionality
    exportReportBtn.addEventListener("click", exportReport);

    // Saved cases functionality
    searchSavedCasesInput.addEventListener("input", () => {
      renderSavedCases(searchSavedCasesInput.value);
    });

    clearSavedCasesBtn.addEventListener("click", () => {
      if (!confirm("Are you sure you want to clear all saved cases? This cannot be undone.")) return;
      
      try {
        localStorage.removeItem(SAVED_CASES_KEY);
        renderSavedCases();
        showMessage("All saved cases cleared", "success");
      } catch (error) {
        showMessage("Error clearing saved cases", "error");
      }
    });

    // Initialize the application
    function initializeApp() {
      try {
        renderCategories();
        renderManageCategories();
        renderSavedCases();
        showMessage("OSINT Search Tool loaded successfully", "success");
      } catch (error) {
        showMessage("Error initializing application", "error");
      }
    }

    // Run initialization when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
      initializeApp();
    }
  </script>
</body>
</html>